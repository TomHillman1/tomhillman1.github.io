<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Vinyl</title>
  <style>
    :root { --pad: 12px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; margin: 0; padding: 2rem; }
    h1 { margin: 0 0 1rem; }
    .hint { color:#666; margin: .25rem 0 1rem; font-size: .95rem; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eee; padding: var(--pad); text-align: left; vertical-align: middle; }
    th { background: #fafafa; position: sticky; top: 0; }
    img.thumb { width: 64px; height: 64px; object-fit: cover; border-radius: 6px; background:#f3f3f3; display:block; }
    .grid { overflow-x: auto; background: white; border: 1px solid #eee; border-radius: 10px; }
    @media (max-width: 640px) {
      th:nth-child(4), td:nth-child(4) { display:none; } /* hide notes on small screens */
    }
  </style>
</head>
<body>
  <h1>My Vinyl</h1>
  <div class="hint">Barebones list pulled from Supabase (records + signed cover images).</div>
  <div class="grid">
    <table id="tbl">
      <thead>
        <tr>
          <th>Cover</th>
          <th>Artist</th>
          <th>Title</th>
          <th>Year</th>
        </tr>
      </thead>
      <tbody id="rows"><tr><td colspan="4">Loadingâ€¦</td></tr></tbody>
    </table>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js";

    // TODO: set these
    const SUPABASE_URL = "https://qwxajqhkfgcvhifuuirp.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF3eGFqcWhrZmdjdmhpZnV1aXJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5Mzc2MjMsImV4cCI6MjA3MTUxMzYyM30.YD3Qzb5Llw7Cwq-i9Up-q94cXlAvRD4D8BWdx9cWVFo";
    const BUCKET = "media"; // your private bucket name

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const tbody = document.getElementById("rows");

    // Sign in anonymously so storage/object policies with "to authenticated" apply
    const { error: authErr } = await supabase.auth.signInAnonymously();
    if (authErr) {
      tbody.innerHTML = `<tr><td colspan="4">Auth error: ${authErr.message}</td></tr>`;
      throw authErr;
    }

    // Fetch all records (adjust columns to match your schema)
    const { data: records, error } = await supabase
      .from("records")
      .select("id, artist, title, year, cover_url")
      .order("artist", { ascending: true })
      .order("year", { ascending: true });

    if (error) {
      tbody.innerHTML = `<tr><td colspan="4">Load error: ${error.message}</td></tr>`;
      throw error;
    }

    // For each record, create a signed URL for the cover (if any)
    async function signedCover(path) {
      if (!path) return null;
      const { data, error } = await supabase.storage.from(BUCKET).createSignedUrl(path, 60 * 60); // 1 hour
      return error ? null : data.signedUrl;
    }

    // Generate rows
    const rows = await Promise.all(
      (records ?? []).map(async (r) => {
        const coverUrl = await signedCover(r.cover_url);
        const img = coverUrl
          ? `<img class="thumb" src="${coverUrl}" alt="Cover of ${r.title}">`
          : `<div style="width:64px;height:64px;border-radius:6px;background:#eee;"></div>`;
        return `
          <tr>
            <td>${img}</td>
            <td>${escapeHtml(r.artist ?? "")}</td>
            <td>${escapeHtml(r.title ?? "")}</td>
            <td>${r.year ?? ""}</td>
          </tr>
        `;
      })
    );

    tbody.innerHTML = rows.length ? rows.join("") : `<tr><td colspan="4">No records yet.</td></tr>`;

    // Tiny helper to avoid HTML injection when rendering strings
    function escapeHtml(s) {
      return String(s)
        .replaceAll("&", "&amp;")
        .replaceAll("<", "&lt;")
        .replaceAll(">", "&gt;")
        .replaceAll('"', "&quot;")
        .replaceAll("'", "&#039;");
    }
  </script>
</body>
</html>
